## 一、设备角色

***ISW*** *I*nternet-Connection *Sw*itch 互联网出口交换机 #外网接入 
互联ISP、客户外网、客户骨干网接入，或外网接入多 AZ，多 Region 场景下 DCI 互联。

***DSW*** *D*istribution *Sw*itch 分布层交换机 #数据交换 
用于连接各个ASW、ISW、LSW。

***ASW*** *A*ccess *Sw*itch 接入层交换机 #数据交换 
用于接入云平台服务器，分为 ASW.10GE 和 ASW.25GE。

***LSW*** *L*VS *Sw*itch 综合接入交换机 #综合接入 
云产品如 SLB、XGW、DNS 等接入设备。

***CSW*** *C*ustomer *Sw*itch 客户接入交换机 #内网接入 
接入客户内网、VPC 专线接入。

***OMR*** *O*ut-of-Band *M*anger *R*outer/Switch 带外核心交换机 #带外管理
带外核心网关设备。

***OSW-N*** *O*ut-of-Band *Sw*itch for *N*etwork Deivces 带外汇聚交换机-网络 #带外管理
网络设备带外接入汇聚。

***OSW-S*** *O*ut-of-Band *Sw*itch for *S*ervers 带外汇聚交换机-服务器 #带外管理
服务器带外接入汇聚。

***OASW*** *O*ut-of-Band *A*ccess *Sw*itch 带外接入层交换机 #带外管理
带外接入层交换机。

***ACS*** *A*ccess *c*onsole *s*erver 串口服务器 #带外管理 
接入所有交换机的 console 接口。

***Splitter*** 分光器 #内网接入 #外网接入 
分光设备，适配 ISW 侧云盾 beaver。

***CswSplitter*** *C*ustomer *Sw*itch *Splitter* 分光器 #内网接入 #外网接入 
分光设备，适配 CSW 侧云盾 beaver。

***TAPSW*** *T*est *A*ccess *P*oint *Sw*itch 分流交换机 #内网接入 #外网接入 
第二代为分流交换机，适配云盾 beaver。

***HSW*** *H*ybrid *Sw*itch 混合接入交换机 #数据交换 
云接入网关设备，裸机万兆接入。

***OHSW*** *O*ut-of-Band of *H*ybrid *Sw*itch 云接入网关带外接入交换机 #带外管理 
带内接入 HSW 服务器专用带外接入层交换云接入网关带外接入交换机。

Tips：HSW 的部署方式采用堆叠，用于配合云平台的云接入网关服务实现裸金属服务器纳管能力，为裸金属服务器提供接入到云平台 VPC 网络的能力。

## 二、详细架构

### 数据交换分区

数据交换分区是整个网络的核心，根据网络规模支持 DSW 4 台横向扩展；
各个 DSW 相互之间没有互联，整个数据交换模块内部 DSW 与 ASW 之间，以及与各个模块之间均用 EBGP 互联；
通过 DSW 接收 ISW 发布的互联网路由，发布云产品公网服务地址网段到 ISW；
ASW 两两一组，接入的服务器网卡 bond 配置 mode=4 双归接入到一组 ASW，ASW 可细分为 ASW.10GE 或 ASW.25GE；
在老版本架构中，会有一组 ASW.GE（千兆电口接入交换机）用于 LSW 链接的服务器的带内管理。

![[Pasted image 20240913095357.png]]

### 综合接入分区

各类云网络相关的服务器（XGW/SLB/OPS/DNS）分别与两台 LSW 互联；
在10GE接入+40GE核心的网络架构中，LSW 的互联采用2\*40G，上行到 DSW 采用2台\*4条\*40G，上行到 CSW 采用2台\*8条\*10G。右图展示的是25G场景下推荐的 LSW 交换机网络结构；
两台 LSW 之间通过 IBGP 交互路由信息；LSW 与 DSW、CSW 之间通过 EBGP 交换路由信息；LSW 和下连的网络相关的服务器也建立 EBGP 邻居交换路由信息。LSW 无论在老版本还是新版本的网络架构中，都**不使用堆叠特性**；
当前架构中每个云平台单个可用区只能有一组 LSW，不支持扩容新一组的 LSW。

![[Pasted image 20240913101709.png]]

### 内网接入分区

两台 CSW 为内部用户提供3类网络接入能力：

1. VPC 业务网络接入；
2. 经典网络云服务接入；
3. 云平台运营和运维管理接入。

VPC 接入由 CSW 的 VRF 和 VxLAN 功能实现云平台内部用户的网络隔离路由信息传递、VPC 与 VRF 的映射；
CSW 与综合接入分区通过10G或40G端口互联（视整体网络架构选型而定），通过 EBGP 交互路由，提供到业务服务区的所有资源访问；CSW 与用户内网（即云平台外部）互联可采用10GE、40GE、100GE链路类型互联，通过静态或者 EBGP 交互路由。
CSW 两台为一组，目前云平台单个可用区内只支持部署一组 CSW 交换机，不支持扩展为多组;
CSW 交换机两台之间不做互连线，在 VxLAN 网络中作为不同的 VTEP 节点。如果所示的是25G接入、100G核心网络架构场景的推荐组网。

![[Pasted image 20240913111536.png]]

### 外网接入分区

由两台 ISW 作为一组外网接入节点，通常和客户的互联网出口安全区互联，也可在云平台内部安全能力配置齐全的情况下直接与 ISP 连接，可通过静态路由或 EBGP 实现云网络内外部路由分发交互；两台 ISW 之间通过 IBGP 交互路由信息；
外网访问云网络的流量通过分光、分流器引流至 beaver，beaver 监测到攻击流量后可通知云平台内部安全管控构造响应报文，发送到外部实现攻击会话阻断；
ISW 上行带宽根据用户云网络需求和 ISP 出口带宽确定；
当前 ISW 仅支持每个云平台内部署一组，不支持扩展多组；
如图所示是25G接入+100G核心的网络架构场景的推荐组网。

![[Pasted image 20240913145844.png]]

### 带外管理分区

![[Pasted image 20240913153728.png]]

**服务器管理网络（VLAN 10）**
每台服务器的 MGMT 口（management 管理口）上联 GE 网线至 OASW 交换机。每台 OASW 交换机配置48千兆网口。
OASW 交换机二层透传，上联至 OSW-S 交换机，网关配置在 OMR 交换机。
**网络设备管理网络（VLAN 8）**
每台网络设备 MGMT 口上联 GE 网线至 OSW-N 交换机。每台 OSW-N 交换机配置48千兆网口。
OSW-N 交换机二层透传，上联至 OMR 交换机，网络设备管理网络网关配置在 OMR 交换机上。
**网络设备 Console 口网络**
每台网络设备 Console 口上联 GE 网线至 ACS，ACS 上联至 OMR 交换机。
两台 OMR 交换机间配置 VRRP，作为服务器和网络设备的网关，同时和下联 OSW-N、OSW-S 使能 MSTP 保证网络没有环路。

![[Pasted image 20240913150602.png]]

## 三、总体架构

![[Pasted image 20240913153856.png]]

### 10GE 组网-中小规模

![[Pasted image 20240913154038.png]]
### 10GE 组网-大规模

![[Pasted image 20240913153929.png]]

### 25GE 组网-中小规模

![[Pasted image 20240913154350.png]]

### 25GE 组网-大规模

![[Pasted image 20240913154452.png]]

### 同城容灾

![[Pasted image 20240913154533.png]]

OPS 服务器

OPS服务器指的是阿里专有云部署和使用过程中的运维服务器，其中运行了专有云中的tianji组件、opsbuild工具OPS-DNS、pangu存储等底座重要组件。
opsbuild工具旨在解决各个场景交付产品化问题，通过salt框架实现一个自动化框架。通过ops命令调用相关组件协同完成服务器操作系统的安装。ops组件包括，oob、clone、cloneweb、mysql、dns、yum。每个ops组件分为主备两个容器，分别部署在ops1和ops2两个物理机上。OPS组件除cone都使用keepalived的vrrp来进行高可用的。vrp有一个浮动IP,我们也称为vip(注意这个VIP和SLB的VIP是两个东西,在部署OPS组件的时候,SLB还没有起来).所有对外提供的服务都是通过这个vip的。OPS-DNS包含云平台所有域名的解析记录，是云底座所有组件之间进行域名调用的重要依赖。云平台的交付部署，是从手工U盘装机OPS1服务器开始的，通过OPS1服务器的clone等组件自动化拉起其他OPS服务器和tiani服务，再配合tiani对规划好的终态文件做解析，自动化的完成其他所有服务器和软件的部署

OPS拥有有OOB组件，即提供带外管理的功能，例如带外IP分配、提供带外管理接口等。故OPS需要与OSW-S和OSW-N相连。OPS拥有clone组件，即提供提供clone装机的功能例如带内临时装机IP分配，提供PXE装机文件下载等。故OPS需要与ASW相连。
OPS拥有DNS组件，即提供DNS解析服务，在阿里专有云中，DNS被定义为云服务，需要从综合接入分区进行接入。故OPS需要与LSW相连，通过LSW将DNS服务器的vip发布到经典网络,

![[Pasted image 20240913155159.png]]

网络规模

ASW.10GE两台为一对基本部署单元，进行堆叠后提供跨设备的链路聚合能力。单台提供48个万兆接入端 口，和4*40G的上行端，2*40G的互连端口(堆叠链路)
ASW.25GE两台为一对基本部署单元，不做堆叠互连线，通过交换机s-mlag技术配合服务器双发ARP技术，提供跨设备的链路聚合能力。单台提供48个25G接入端 口，和8*100G的上行端口
DSW数量可选2台或者4台，同时根据网络规模可选DSW设备款型为4槽位或者8槽位，且每个槽位最大支持36*40G端口密度或选用36*100G端口密度的板卡:

![[Pasted image 20240913155320.png]]

阿里专有云网络逻辑分区分为:外网接入分区、内网接入分区、数据交换分区、综合接入分区。
外网接入分区主要负责接入公网的数据流量，提供访问互联网的能力。
内网接入分区主要负责接入客户内网的数据流量，提供客户访问云内的能力。
数据交换分区主要负责承载云内设备的东西向流量，提供不同组件互访的能力。
综合接入分区主要负责接入云服务的数据流量，提供个资源与云服务互访的能力。
OPS服务器需要与OSW-N、OSW-S、万兆ASW、LSW互联。